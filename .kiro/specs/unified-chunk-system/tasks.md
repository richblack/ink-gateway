# Implementation Plan

- [x] 1. 設計和創建統一資料表結構
  - 創建新的 chunks 主表，包含所有必要欄位和索引
  - 設計輔助表結構：chunk_tags, chunk_hierarchy, chunk_search_cache
  - 實作資料庫觸發器維護主表和輔助表的一致性
  - 撰寫資料表創建和索引優化的 SQL 腳本
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 2. 實作核心資料存取層
  - [x] 2.1 建立統一 Chunk 資料存取介面
    - 定義 UnifiedChunkService 介面和核心資料結構
    - 實作基本 CRUD 操作：CreateChunk, GetChunk, UpdateChunk, DeleteChunk
    - 實作批量操作：BatchCreateChunks, BatchUpdateChunks
    - 撰寫基本 CRUD 操作的單元測試
    - _Requirements: 1.1, 1.2, 8.1, 8.2, 8.3_

  - [x] 2.2 實作多對多標籤關係操作
    - 實作標籤操作方法：AddTags, RemoveTags, GetChunkTags, GetChunksByTag
    - 實作多標籤查詢：GetChunksByTags 支援 AND/OR 邏輯
    - 確保主表 tags 欄位與 chunk_tags 輔助表的同步更新
    - 撰寫標籤關係操作的單元測試和整合測試
    - _Requirements: 2.1, 2.2, 2.3, 2.4_

  - [x] 2.3 實作層級結構操作
    - 實作層級查詢方法：GetChildren, GetDescendants, GetAncestors
    - 實作層級移動操作：MoveChunk 並自動更新 chunk_hierarchy 表
    - 實作路徑查詢和深度限制功能
    - 撰寫層級結構操作的測試案例
    - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3. 實作查詢效能優化系統
  - [x] 3.1 建立查詢快取機制
    - 實作 CacheService 介面和記憶體快取實作
    - 實作查詢結果快取和快取失效策略
    - 建立快取鍵生成和 TTL 管理機制
    - 撰寫快取系統的單元測試和效能測試
    - _Requirements: 6.1, 6.2, 6.3, 6.4_

  - [x] 3.2 實作資料庫查詢優化
    - 實作 prepared statements 和查詢優化策略
    - 建立複合索引和部分索引優化常用查詢
    - 實作查詢執行計劃分析和慢查詢記錄
    - 撰寫查詢效能的基準測試
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 7.1, 7.2, 7.3, 7.4_

  - [x] 3.3 實作搜尋快取表機制
    - 建立 chunk_search_cache 表的操作邏輯
    - 實作複雜查詢結果的快取和過期管理
    - 實作快取命中率統計和優化建議
    - 撰寫搜尋快取的測試案例
    - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 4. 實作效能監控和資料一致性檢查
  - [x] 4.1 建立效能監控系統
    - 實作 PerformanceMonitor 介面和查詢統計功能
    - 建立慢查詢記錄和效能指標收集機制
    - 實作查詢執行時間監控和告警功能
    - 撰寫效能監控的測試和驗證邏輯
    - _Requirements: 9.1, 9.2, 9.3, 9.4_

  - [x] 4.2 實作資料一致性檢查工具
    - 建立 ConsistencyChecker 檢查主表和輔助表的資料一致性
    - 實作自動修復機制處理資料不一致問題
    - 建立資料遷移和同步更新的驗證邏輯
    - 撰寫資料一致性檢查和修復的測試案例
    - _Requirements: 10.1, 10.2, 10.3, 10.4_

- [x] 5. 重構現有 API 層整合統一資料表
  - [x] 5.1 更新 HTTP API 端點
    - 修改現有的 chunks 相關 API 使用新的統一資料表結構
    - 更新標籤操作 API 支援多對多關係和批量操作
    - 修改層級結構 API 使用新的高效能查詢方法
    - 撰寫 API 端點的整合測試
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 5.1, 5.2, 5.3, 5.4_

  - [x] 5.2 實作批量操作 API
    - 建立批量插入和更新 chunks 的 API 端點
    - 實作批量標籤操作和層級移動的 API
    - 加入事務處理確保批量操作的資料一致性
    - 撰寫批量操作 API 的效能測試
    - _Requirements: 8.1, 8.2, 8.3, 8.4_

  - [x] 5.3 整合快取和效能監控到 API 層
    - 在 HTTP handlers 中整合查詢快取機制
    - 加入效能監控和慢查詢記錄到所有 API 端點
    - 實作 API 回應時間監控和統計
    - 撰寫 API 效能監控的測試案例
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 9.1, 9.2, 9.3, 9.4_

- [x] 6. 實作搜尋功能優化
  - [x] 6.1 優化語義搜尋效能
    - 更新向量搜尋使用統一 chunk_id 索引
    - 實作搜尋結果快取和預載入機制
    - 優化搜尋查詢的資料庫 JOIN 操作
    - 撰寫語義搜尋效能的基準測試
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

  - [x] 6.2 實作高效能標籤搜尋
    - 建立標籤統計視圖和快速標籤查詢
    - 實作標籤組合搜尋的優化演算法
    - 加入標籤使用頻率和熱門標籤快取
    - 撰寫標籤搜尋的效能測試
    - _Requirements: 4.1, 4.2, 4.3, 4.4_

  - [x] 6.3 實作全文搜尋優化
    - 建立全文搜尋索引和查詢優化
    - 實作搜尋結果排序和相關性評分
    - 加入搜尋建議和自動完成功能
    - 撰寫全文搜尋的測試案例
    - _Requirements: 7.3, 7.4_

- [x] 7. 資料遷移和向後相容性
  - [x] 7.1 實作資料遷移腳本
    - 建立從舊資料表結構到統一資料表的遷移腳本
    - 實作資料完整性驗證和錯誤處理機制
    - 建立遷移進度監控和回滾機制
    - 撰寫資料遷移的測試和驗證邏輯
    - _Requirements: 10.3, 10.4_

  - [x] 7.2 確保 API 向後相容性
    - 維持現有 API 端點的回應格式相容性
    - 實作舊 API 到新資料結構的適配層
    - 加入 API 版本控制和廢棄警告機制
    - 撰寫向後相容性的測試案例
    - _Requirements: 1.4, 2.4_

- [x] 8. 效能測試和優化
  - [x] 8.1 建立大資料量效能測試
    - 建立百萬級資料的測試資料集
    - 實作各種查詢場景的效能基準測試
    - 測試並發查詢和高負載情況下的系統表現
    - 建立效能回歸測試和持續監控
    - _Requirements: 3.1, 3.2, 3.3, 3.4_

  - [x] 8.2 優化查詢效能和資源使用
    - 分析慢查詢並優化索引策略
    - 調整資料庫連線池和快取配置
    - 優化記憶體使用和垃圾回收效能
    - 撰寫效能優化的文件和最佳實踐指南
    - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 9. 整合測試和部署準備
  - [x] 9.1 建立完整的整合測試套件
    - 撰寫端到端的工作流程測試
    - 測試資料一致性和錯誤恢復機制
    - 驗證所有 API 端點的正確性和效能
    - 建立自動化測試和持續整合流程
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

  - [x] 9.2 準備生產環境部署
    - 建立生產環境的資料庫配置和優化設定
    - 實作健康檢查和監控告警機制
    - 建立備份和災難恢復計劃
    - 撰寫部署文件和運維手冊
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4_

- [x] 10. 文件更新和使用者指南
  - [x] 10.1 更新 API 文件和操作手冊
    - 更新所有 API 端點的文件和範例
    - 修改操作手冊反映新的資料表結構和功能
    - 建立效能調優和故障排除指南
    - 撰寫資料遷移和升級指南
    - _Requirements: 1.4, 2.4, 8.4, 9.4, 10.4_

  - [x] 10.2 建立效能監控和維護文件
    - 撰寫效能監控和指標解讀指南
    - 建立資料一致性檢查和修復流程文件
    - 撰寫容量規劃和擴展建議
    - 建立常見問題和解決方案知識庫
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4_
