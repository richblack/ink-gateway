# 多模態 MCP 系統實作計畫

## 概述

本實作計畫將多模態 MCP 系統的設計轉換為具體的開發任務。採用漸進式開發方式，優先實作核心功能，確保每個階段都能獨立運作和測試。所有任務都專注於程式碼實作，可由開發代理執行。

## 實作任務

### 1. 資料庫擴展與基礎設施

- [x] 1.1 擴展 embeddings 表支援多向量類型
  - 新增 vector_type, model_name, metadata 欄位到 embeddings 表
  - 建立向量類型索引（text/image 分離索引）
  - 撰寫 migration 腳本
  - _需求: 需求 2.2, 6.1_

- [x] 1.2 建立圖片元資料結構定義
  - 在 models 包中定義 MediaMetadata, StorageResult 等結構
  - 定義 StorageType 常數和相關介面
  - 建立圖片處理相關的錯誤類型
  - _需求: 需求 1.1, 1.2_

- [x] 1.3 擴展 UnifiedChunk metadata 結構驗證
  - 建立 metadata 欄位的 JSON schema 驗證
  - 實作圖片 metadata 的序列化/反序列化函數
  - 新增 metadata 查詢輔助函數
  - _需求: 需求 1.3, 2.1_

### 2. 儲存抽象層實作

- [x] 2.1 實作 MediaStorageAdapter 介面
  - 在 services 包中定義完整的 MediaStorageAdapter 介面
  - 建立儲存適配器工廠模式和註冊機制
  - 實作儲存配置管理和驗證
  - _需求: 需求 7.1, 7.3_

- [x] 2.2 實作 Supabase Storage 適配器
  - 整合 Supabase Storage Go 客戶端
  - 實作檔案上傳、下載、刪除功能
  - 實作 URL 生成和存取驗證
  - 新增錯誤處理和重試機制
  - _需求: 需求 1.1, 1.4_

- [x] 2.3 實作本地檔案系統適配器
  - 實作本地檔案的上傳和管理
  - 建立目錄結構管理（按日期分組）
  - 實作檔案 URL 生成和存取
  - 新增檔案權限和安全檢查
  - _需求: 需求 7.4_

- [ ]* 2.4 撰寫儲存適配器單元測試
  - 測試 Supabase Storage 適配器的所有功能
  - 測試本地儲存適配器的檔案操作
  - 測試錯誤處理和邊界條件
  - 建立 mock 適配器供其他測試使用
  - _需求: 需求 7.1_

### 3. 圖片處理服務實作

- [x] 3.1 實作檔案雜湊計算服務
  - 在 services 包中實作 HashService 介面
  - 實作 SHA256 雜湊計算功能，支援 io.Reader 介面
  - 新增檔案去重檢查邏輯，整合資料庫查詢
  - 實作雜湊快取機制提升效能
  - _需求: 需求 1.2, 1.4_

- [x] 3.2 整合 GPT-4 Vision API 服務
  - 在 services 包中實作 VisionAIService 介面
  - 整合 OpenAI GPT-4 Vision API 客戶端
  - 實作圖片分析和描述生成，支援多語言
  - 新增 API 錯誤處理和重試邏輯
  - _需求: 需求 2.1, 2.3_

- [x] 3.3 整合 CLIP 圖片向量化服務
  - 擴展現有 EmbeddingService 支援圖片向量
  - 整合 CLIP API 或本地 CLIP 服務
  - 實作圖片向量生成功能，統一 512 維度
  - 實作向量正規化和品質驗證
  - _需求: 需求 2.2, 2.5_

- [x] 3.4 實作 MediaProcessor 核心服務
  - 建立 MediaProcessor 服務整合所有圖片處理功能
  - 實作單張圖片完整處理流程（上傳→分析→向量化→儲存）
  - 實作圖片元資料提取（尺寸、格式、EXIF 等）
  - 建立 UnifiedChunk 記錄建立和更新邏輯
  - _需求: 需求 1.1, 2.1, 2.2_

- [ ]* 3.5 撰寫圖片處理服務測試
  - 測試檔案雜湊計算的準確性和效能
  - 測試 Vision API 整合和錯誤處理
  - 測試 CLIP 向量生成功能和品質
  - 建立端到端圖片處理測試
  - _需求: 需求 2.1, 2.2_

### 4. 批次處理功能實作

- [x] 4.1 實作資料夾掃描功能
  - 在 services 包中實作 FolderScanner 服務
  - 實作遞迴資料夾掃描，支援深度限制
  - 支援圖片格式過濾（png, jpg, gif, webp, bmp）
  - 實作檔案大小和權限檢查，跳過無效檔案
  - _需求: 需求 3.1_

- [x] 4.2 實作批次處理協調器
  - 建立 BatchProcessor 服務管理批次任務
  - 實作 goroutine pool 控制並行處理數量
  - 實作進度追蹤和狀態報告，支援即時查詢
  - 新增暫停/恢復/取消功能
  - _需求: 需求 3.2, 3.3, 3.5_

- [x] 4.3 實作批次處理錯誤管理
  - 建立錯誤收集和分類系統（網路錯誤、檔案錯誤等）
  - 實作部分失敗處理邏輯，繼續處理其他檔案
  - 建立詳細的處理報告生成（成功/失敗統計）
  - 實作失敗任務重試機制，支援指數退避
  - _需求: 需求 3.4_

- [ ]* 4.4 撰寫批次處理測試
  - 測試資料夾掃描功能和邊界條件
  - 測試並行處理效能和穩定性
  - 測試錯誤處理和恢復機制
  - 建立大量檔案處理的壓力測試
  - _需求: 需求 3.5_

### 5. 多模態搜尋服務實作

- [x] 5.1 擴展現有搜尋服務支援圖片向量
  - 擴展 SearchService 介面新增 MultimodalSearch 方法
  - 修改 Supabase 客戶端支援多模態向量搜尋
  - 實作向量類型過濾（text/image/all）和索引選擇
  - 新增搜尋結果類型標示和匹配解釋
  - _需求: 需求 6.1, 6.4_

- [x] 5.2 實作混合搜尋演算法
  - 實作文字和圖片向量的權重合併演算法
  - 建立搜尋結果排序和去重邏輯
  - 實作相似度閾值過濾和結果品質控制
  - 新增搜尋解釋和匹配原因生成
  - _需求: 需求 6.3, 6.4_

- [x] 5.3 實作以圖搜圖功能
  - 實作參考圖片的向量生成和快取
  - 建立圖片相似度比較邏輯
  - 實作圖片上傳和臨時處理流程
  - 新增相似圖片推薦演算法和排序
  - _需求: 需求 6.2_

- [x] 5.4 實作 Slide Generator 圖片推薦服務
  - 建立 SlideImageRecommendation 服務
  - 分析文字內容並生成查詢向量
  - 實作上下文相關的圖片推薦邏輯
  - 建立推薦理由生成和結果排序
  - _需求: 需求 5.1, 5.2, 5.5_

- [ ]* 5.5 撰寫多模態搜尋測試
  - 測試圖片向量搜尋準確性和效能
  - 測試混合搜尋演算法效果
  - 測試以圖搜圖功能和相似度計算
  - 建立搜尋效能基準測試
  - _需求: 需求 6.1, 6.2, 6.3_

### 6. HTTP API 端點實作

- [x] 6.1 實作圖片上傳 API 端點
  - 在 handlers 包中建立 MediaHandler
  - 實作 POST /api/v1/media/upload 端點
  - 實作 multipart/form-data 檔案上傳處理
  - 新增檔案大小和格式驗證，整合完整處理流程
  - _需求: 需求 1.1, 2.1_

- [x] 6.2 實作批次處理 API 端點
  - 建立 POST /api/v1/media/batch-scan 端點
  - 實作 GET /api/v1/media/batch/{id}/status 狀態查詢端點
  - 新增批次任務管理功能（暫停/恢復/取消）
  - 建立處理進度的 Server-Sent Events (SSE) 支援
  - _需求: 需求 3.1, 3.2_

- [x] 6.3 實作多模態搜尋 API 端點
  - 擴展現有 SearchHandler 支援多模態搜尋
  - 建立 POST /api/v1/search/multimodal 端點
  - 實作搜尋參數驗證和解析（文字+圖片查詢）
  - 整合快取機制提升搜尋效能
  - _需求: 需求 6.1, 6.3_

- [x] 6.4 實作圖片分析 API 端點
  - 建立 POST /api/v1/media/analyze 端點
  - 支援 URL 和檔案上傳兩種分析方式
  - 實作分析選項參數處理（詳細程度、語言等）
  - 新增分析結果快取機制
  - _需求: 需求 2.1, 4.3_

- [ ]* 6.5 撰寫 API 端點測試
  - 測試所有 API 端點的功能正確性
  - 測試錯誤處理和邊界條件
  - 測試檔案上傳和處理流程
  - 建立 API 效能和負載測試
  - _需求: 需求 1.1, 2.1, 3.1_

### 7. MCP Server 實作

- [x] 7.1 實作 MCP 協議基礎框架
  - 建立新的 mcp 包實作 MCP 協議規範
  - 建立 MCP Server 基礎結構和 stdio 通訊
  - 實作工具註冊和管理機制
  - 新增 MCP 訊息處理和錯誤處理
  - _需求: 需求 4.1, 4.5_

- [x] 7.2 實作核心 MCP Tools
  - 實作 ink_search_chunks 工具（支援多模態搜尋）
  - 實作 ink_create_chunk 工具（支援圖片 chunk）
  - 實作 ink_analyze_image 工具
  - 實作 ink_upload_image 工具
  - _需求: 需求 4.1, 4.2, 4.3_

- [x] 7.3 實作進階 MCP Tools
  - 實作 ink_batch_process_images 工具
  - 實作 ink_get_images_for_slides 工具
  - 實作 ink_search_images 工具
  - 實作 ink_hybrid_search 工具
  - _需求: 需求 4.1, 5.1, 5.2_

- [x] 7.4 實作 MCP Resources 和 Prompts
  - 定義 ink://chunks/{chunk_id} 資源
  - 定義 ink://images/{chunk_id} 資源
  - 建立搜尋結果資源格式
  - 實作資源存取和權限控制
  - _需求: 需求 4.4, 8.1_

- [ ]* 7.5 撰寫 MCP Server 測試
  - 測試 MCP 協議通訊正確性
  - 測試所有 MCP Tools 功能
  - 測試 MCP Resources 存取
  - 建立端到端 MCP 整合測試
  - _需求: 需求 4.5, 8.1_

### 8. Obsidian Plugin 整合

- [x] 8.1 擴展 Obsidian Plugin 支援圖片上傳
  - 修改現有 obsidian-ink-plugin 支援圖片拖放上傳
  - 整合 Ink-Gateway 圖片上傳 API
  - 實作上傳進度顯示和錯誤處理
  - 新增圖片連結插入功能和預覽
  - _需求: 需求 1.1, 8.2_

- [x] 8.2 實作圖片管理介面
  - 建立圖片庫瀏覽介面和縮圖顯示
  - 實作圖片預覽和 AI 描述顯示
  - 新增圖片標籤編輯功能
  - 建立圖片搜尋和過濾功能
  - _需求: 需求 6.1, 6.5_

- [x] 8.3 實作批次處理介面
  - 建立資料夾選擇和掃描介面
  - 實作批次處理進度顯示（即時更新）
  - 新增處理選項設定功能（儲存類型、分析選項等）
  - 建立處理報告顯示介面
  - _需求: 需求 3.1, 3.2, 3.4_

- [ ]* 8.4 撰寫 Plugin 整合測試
  - 測試圖片上傳和處理流程
  - 測試圖片管理介面功能
  - 測試批次處理介面
  - 建立使用者體驗測試
  - _需求: 需求 1.1, 3.1_

### 9. 系統整合與優化

- [ ] 9.1 實作系統設定管理
  - 擴展現有 config 包支援多模態設定
  - 建立儲存適配器設定切換功能
  - 實作 AI 服務設定管理（API 金鑰、端點等）
  - 建立設定驗證和測試功能
  - _需求: 需求 7.1, 7.2_

- [ ] 9.2 實作快取和效能優化
  - 擴展現有快取服務支援圖片分析結果
  - 實作向量搜尋結果快取機制
  - 新增檔案雜湊快取機制避免重複計算
  - 優化資料庫查詢效能和索引使用
  - _需求: 需求 8.4_

- [ ] 9.3 實作監控和日誌系統
  - 擴展現有 PerformanceMonitor 支援圖片處理監控
  - 實作 API 呼叫統計和日誌記錄
  - 新增錯誤追蹤和報告機制
  - 建立系統健康檢查功能
  - _需求: 需求 4.5, 8.4_

- [ ]* 9.4 撰寫系統整合測試
  - 建立端到端系統測試
  - 測試多使用者並行處理
  - 測試系統負載和穩定性
  - 建立效能基準測試
  - _需求: 需求 8.1, 8.4_

### 10. 文件和部署

- [ ] 10.1 撰寫 API 參考文件
  - 更新現有 API 文件支援多模態端點
  - 撰寫 MCP Tools 使用指南和範例
  - 建立圖片處理 API 程式碼範例
  - 新增多模態搜尋錯誤碼和故障排除指南
  - _需求: 需求 4.4, 8.1_

- [ ] 10.2 建立部署和設定指南
  - 撰寫 Supabase Storage 設定指南
  - 建立 AI 服務 API 金鑰設定說明（OpenAI、CLIP）
  - 撰寫 MCP Server 部署指南
  - 更新 Obsidian Plugin 安裝說明
  - _需求: 需求 7.1, 8.1_

- [ ] 10.3 建立開發環境設定
  - 更新現有 Docker Compose 支援多模態服務
  - 撰寫本地開發設定指南（包含 AI 服務配置）
  - 建立測試資料和範例圖片檔案
  - 新增多模態相關的開發工具和腳本
  - _需求: 需求 8.1_

- [ ]* 10.4 撰寫使用者手冊
  - 建立 Obsidian Plugin 圖片功能使用手冊
  - 撰寫 MCP Tools 多模態使用範例
  - 建立多模態系統常見問題解答
  - 新增圖片管理最佳實踐建議
  - _需求: 需求 8.1, 8.2_

## 實作優先序

### Phase 1: 核心基礎 (任務 1-3)
**目標**: 建立基本的圖片處理能力
- 資料庫擴展
- 儲存抽象層
- 基礎圖片處理服務

### Phase 2: API 和搜尋 (任務 4-6)
**目標**: 提供完整的圖片管理和搜尋功能
- 批次處理功能
- 多模態搜尋
- HTTP API 端點

### Phase 3: MCP 整合 (任務 7-8)
**目標**: 實現跨平台存取能力
- MCP Server 實作
- Obsidian Plugin 整合

### Phase 4: 優化和部署 (任務 9-10)
**目標**: 系統優化和生產就緒
- 效能優化
- 監控系統
- 文件和部署

## 成功標準

### Phase 1 完成標準
- ✅ 可以上傳圖片到 Supabase Storage
- ✅ 可以生成 AI 描述和向量
- ✅ 可以在 UnifiedChunk 中查詢圖片

### Phase 2 完成標準
- ✅ 可以批次處理資料夾中的圖片
- ✅ 可以進行多模態搜尋
- ✅ API 端點功能完整

### Phase 3 完成標準
- ✅ MCP Server 可以獨立運作
- ✅ Obsidian 可以管理圖片
- ✅ VSCode/Claude Desktop 可以查詢知識庫

### Phase 4 完成標準
- ✅ 系統效能達到設計目標
- ✅ 完整的文件和部署指南
- ✅ 生產環境就緒

## 技術債務管理

### 必須實作的核心功能
- 所有非標記 "*" 的任務都是核心功能
- 這些任務確保系統基本可用

### 可選的增強功能
- 標記 "*" 的任務是測試和文件相關
- 可以在時間允許時實作
- 有助於系統品質但非必需

### 未來擴展預留
- Google Drive 適配器實作
- NAS 儲存支援
- 進階 AI 分析功能
- 多語言支援