# 需求文件

## 簡介

本文件概述開發 Obsidian 插件的需求，該插件將作為 Ink-Gateway 系統的前端介面。此插件將使用戶能夠透過 Obsidian 的介面與統一區塊系統互動，提供 AI 聊天功能、自動內容處理、語義搜尋、模板管理和階層內容解析。

## 需求

### 需求 1

**使用者故事：** 作為 Obsidian 使用者，我希望在 Obsidian 內有一個 AI 聊天視窗，以便我可以透過 Ink-Gateway 系統與 AI 互動來處理和查詢我的筆記。

#### 驗收標準

1. 當使用者開啟插件時，系統應在 Obsidian 內顯示 AI 聊天介面
2. 當使用者在聊天視窗中輸入訊息時，系統應將請求發送到 Ink-Gateway 的 AI 服務
3. 當 AI 回應時，系統應在聊天介面中顯示回應
4. 當聊天視窗開啟時，系統應在會話期間維護聊天歷史記錄

### 需求 2

**使用者故事：** 作為 Obsidian 使用者，我希望在完成輸入時自動處理內容，以便我的內容透過 Ink-Gateway 自動儲存到三個資料庫（關聯式、向量、圖形）中。

#### 驗收標準

1. 當使用者在輸入段落後按下 Enter 時，系統應觸發自動處理
2. 當內容處理被觸發時，系統應將內容發送到 Ink-Gateway 進行分塊和儲存
3. 當 Ink-Gateway 處理內容時，系統應將其儲存在所有三個資料庫中（PostgreSQL、PGVector、Amazon AGE）
4. 當處理完成時，系統應向使用者提供視覺回饋
5. 如果處理失敗，系統應顯示錯誤訊息並允許重試

### 需求 3

**使用者故事：** 作為 Obsidian 使用者，我希望有一個語義搜尋視窗，以便我可以搜尋資料庫中的結構化內容，而不僅僅是基於檔案的搜尋。

#### 驗收標準

1. 當使用者開啟搜尋視窗時，系統應顯示與 Obsidian 預設搜尋分離的搜尋介面
2. 當使用者輸入搜尋查詢時，系統應查詢 Ink-Gateway 資料庫（語義、圖形和基於標籤的搜尋）
3. 當搜尋結果返回時，系統應顯示帶有上下文和相關性分數的結果
4. 當使用者點擊搜尋結果時，系統應導航到 Obsidian 中的原始位置
5. 當執行語義搜尋時，系統應使用向量嵌入進行相似性匹配

### 需求 4

**使用者故事：** 作為 Obsidian 使用者，我希望使用模板將我的內容結構化為區塊，以便我可以輕鬆儲存和檢索結構化資訊，如具有預定義插槽的聯絡人。

#### 驗收標準

1. 當使用者建立模板時，系統應將其轉換為具有定義插槽的區塊
2. 當使用者應用模板時，系統應建立具有預定義欄位的結構化內容
3. 當模板內容被儲存時，系統應將每個插槽作為具有關係的單獨區塊儲存
4. 當查詢模板時，系統應返回該模板類型的所有實例
5. 當檢索模板資料時，系統應重建包含所有插槽值的完整模板
6. 如果模板有插槽，系統應將它們映射到 Obsidian 屬性

### 需求 5

**使用者故事：** 作為 Obsidian 使用者，我希望插件能夠解析標題階層和項目符號縮排，以便我的內容結構在區塊關係中得到正確表示。

#### 驗收標準

1. 當解析 markdown 內容時，系統應識別標題層級（H1、H2 等）和項目符號縮排
2. 當內容有標題階層時，系統應基於標題層級建立父子關係
3. 當內容有項目符號縮排時，系統應基於縮排層級建立父子關係
4. 當內容同時有標題和項目符號階層時，系統應正確結合兩種關係類型
5. 當儲存階層內容時，系統應在資料庫中維護父子關係

### 需求 6

**使用者故事：** 作為 Obsidian 使用者，我希望系統記錄原始文字位置，以便當我找到相關區塊時可以導航回 Obsidian 中的來源位置。

#### 驗收標準

1. 當解析內容時，系統應記錄每個區塊的檔案名稱和行號
2. 當儲存區塊時，系統應包含位置元資料（檔案名稱 + 座標）
3. 當顯示搜尋結果時，系統應顯示原始來源位置
4. 當使用者點擊結果時，系統應導航到原始檔案中的確切位置
5. 當內容被修改時，系統應相應更新位置座標

### 需求 7

**使用者故事：** 作為系統架構師，我希望插件與 Ink-Gateway 解耦，以便閘道器可以與其他筆記應用程式（Logseq、RemNote）整合而不影響其核心功能。

#### 驗收標準

1. 當設計插件架構時，系統應使用乾淨的 API 介面與 Ink-Gateway 通訊
2. 當 Ink-Gateway 更新時，插件應繼續運作而無需修改（假設 API 相容性）
3. 當為不同應用程式開發其他插件時，它們應能夠使用相同的 Ink-Gateway API
4. 當插件與 Ink-Gateway 通訊時，系統應使用標準化的 REST API 端點
5. 如果 Ink-Gateway 不可用，插件應優雅地處理斷線並提供適當的使用者回饋

### 需求 8

**使用者故事：** 作為 Obsidian 使用者，我希望插件能夠正確處理標籤和元資料，以便我的內容組織透過 Ink-Gateway 系統得到保留和增強。

#### 驗收標準

1. 當內容有 Obsidian 標籤時，系統應保留並與 Ink-Gateway 同步
2. 當內容有屬性/元資料時，系統應將它們映射到適當的區塊欄位
3. 當在 Obsidian 中修改標籤時，系統應更新 Ink-Gateway 中對應的區塊
4. 當建立新標籤時，系統應在統一區塊系統中註冊它們
5. 當按標籤查詢時，系統應返回所有資料庫中的相關區塊

### 需求 9

**使用者故事：** 作為 Obsidian 使用者，我希望 Obsidian 和 Ink-Gateway 之間有即時同步，以便我的變更立即反映在語義搜尋和 AI 功能中。

#### 驗收標準

1. 當在 Obsidian 中修改內容時，系統應自動將變更同步到 Ink-Gateway
2. 當同步發生時，系統應更新所有三個資料庫（關聯式、向量、圖形）
3. 當同步進行中時，系統應顯示適當的載入指示器
4. 如果同步失敗，系統應將變更排隊重試並通知使用者
5. 當使用者離線時，系統應將變更排隊並在連線恢復時同步

### 需求 10

**使用者故事：** 作為 Obsidian 使用者，我希望系統能夠透過文件 ID 來管理和檢索區塊，以便我可以完整重現原始文件的內容結構，即使在多層級階層中也能精確定位。

#### 驗收標準

1. 當從 Obsidian MD 檔案解析多個段落時，系統應為這些段落分配共同的文件 ID
2. 當儲存區塊到 Ink-Gateway 時，系統應在每個區塊中包含文件 ID 資訊
3. 當查詢特定文件的區塊時，系統應能夠使用文件 ID 檢索所有相關區塊
4. 當重建文件內容時，系統應能夠透過文件 ID 完整還原原始文件結構
5. 如果內容來自虛擬文件（如 RemNote 頁面），系統應建立虛擬文件 ID 來管理相關區塊
6. 當使用文件 ID 分頁檢索時，系統應避免因無限層級而檢索過多不相關的區塊
7. 當文件被修改時，系統應維護文件 ID 的一致性並更新相關區塊